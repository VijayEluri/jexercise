package no.hal.confluence.jexercise.actions;

import java.util.ArrayList;
import java.util.Collection;

import no.hal.confluence.java.ui.actions.PasteLinkedSourceIntoPackageExporerAction;
import no.hal.confluence.java.ui.actions.PasteSourceIntoPackageExplorerHelper;
import no.hal.confluence.ui.actions.PostActionHook;
import no.hal.jex.ui.JexPreferencePage;
import no.hal.jex.ui.JexUiPlugin;
import no.hal.jex.views.ExerciseView;

import org.eclipse.core.resources.IResource;
import org.eclipse.jdt.core.IJavaElement;

public class OpenTestInJExerciseViewAction extends PasteLinkedSourceIntoPackageExporerAction {

	private static final String JEXERCISE_VIEW_ID = "no.hal.jex.views.ExerciseView";
	
	public OpenTestInJExerciseViewAction() {
	}

	@Override
	protected String getSourceFolderString() {
		return JexUiPlugin.getPlugin().getPluginPreferences().getString(JexPreferencePage.JEX_TESTS_PATH);
	}
	
	@Override
	protected String getDefaultSourceFolderName() {
		return "tests";
	}
	
	private PostActionHook<IJavaElement> exerciseViewUpdater = new PostActionHook<IJavaElement>() {
		@Override
		public void postActionHook(Collection<IJavaElement> pastedJavaElements) {
			if (progressMonitor != null) {
				progressMonitor.subTask("Opening in JExercise view");
			}
			ExerciseView exerciseView = (ExerciseView) PasteSourceIntoPackageExplorerHelper.showView(JEXERCISE_VIEW_ID, true);
			Collection<IResource> resources = new ArrayList<IResource>(pastedJavaElements.size());
			for (IJavaElement javaElement : pastedJavaElements) {
				resources.add(javaElement.getResource());
			}
			exerciseView.setRootResources(resources);
//			System.out.println("Opening " + pastedResources + " in JExercise view");
			if (progressMonitor != null) {
				progressMonitor.worked(1);
			}
		}
	};

	@Override
	protected PostActionHook<IJavaElement> getPostActionHook() {
		return exerciseViewUpdater;
	}
}
